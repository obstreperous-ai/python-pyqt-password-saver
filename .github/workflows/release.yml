name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    name: Build Distribution
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel build
        pip install -r requirements.txt
    
    - name: Build source distribution
      run: |
        python -m build --sdist
    
    - name: Build wheel distribution
      run: |
        python -m build --wheel
    
    - name: List distribution files
      run: |
        ls -lh dist/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-packages
        path: dist/
        retention-days: 30
    
    outputs:
      version: ${{ github.ref_name }}
  
  release-macos:
    name: Build macOS Release
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build standalone application with PyInstaller
      run: |
        pyinstaller --name PasswordSaver \
          --windowed \
          --onedir \
          --add-data "ui:ui" \
          main.py
    
    - name: Create DMG (if possible)
      run: |
        # Create a simple zip for macOS distribution
        cd dist
        if [ -d "PasswordSaver.app" ]; then
          zip -r PasswordSaver-macOS-${{ github.ref_name }}.zip PasswordSaver.app
        elif [ -f "PasswordSaver" ]; then
          zip PasswordSaver-macOS-${{ github.ref_name }}.zip PasswordSaver
        fi
        cd ..
      continue-on-error: true
    
    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-app
        path: dist/*.zip
        retention-days: 30
  
  release-linux:
    name: Build Linux Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libxcb-xinerama0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxkbcommon-x11-0
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build standalone application with PyInstaller
      run: |
        pyinstaller --name PasswordSaver \
          --onefile \
          --add-data "ui:ui" \
          main.py
    
    - name: Create Linux archive
      run: |
        cd dist
        tar -czf PasswordSaver-Linux-${{ github.ref_name }}.tar.gz PasswordSaver
        cd ..
    
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-app
        path: dist/*.tar.gz
        retention-days: 30
  
  create-release:
    name: Create GitHub Release
    needs: [build, release-macos, release-linux]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts
    
    - name: Display structure of downloaded files
      run: ls -R release-artifacts
    
    - name: Extract release notes
      id: release_notes
      run: |
        VERSION=${{ github.ref_name }}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Release ${VERSION}" > release_notes.md
        echo "" >> release_notes.md
        echo "## Changes" >> release_notes.md
        echo "" >> release_notes.md
        echo "See commit history for detailed changes." >> release_notes.md
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.release_notes.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          release-artifacts/python-packages/*
          release-artifacts/macos-app/*
          release-artifacts/linux-app/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
